name: Node CI and Artifacts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-test:
    runs-on: self-hosted
    defaults: 
      run: 
        working-directory: ${{ github.workspace }}
    name: Build & Test and Prepare Artifacts
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (dev)
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build static files
        run: npm run build

      - name: Prepare docker-artifact (production runtime)
        run: npm run prepare-artifact

      - name: Upload website artifact
        uses: actions/upload-artifact@v4
        with:
          name: website
          path: dist/

      - name: Upload docker artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-artifact
          path: docker-artifact/

  build-image: 
    needs: build-test
    runs-on: [self-hosted, windows]
    steps: 
      # - name: Checkout code
      #   uses: actions/checkout@v3
      - name: Download docker-artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-artifact
          path: docker-artifact
      - name: Show workspace
        run: |
          echo "Workspace files:"
            # PowerShell friendly listing
            Get-ChildItem -Force
      - name: Show docker-artifact contents
        run: |
          echo "docker-artifact contents:"
            if (Test-Path -Path "docker-artifact") {
              Get-ChildItem -Path docker-artifact -Recurse -Force | Select-Object FullName, Length
            } else {
              Write-Host "docker-artifact not found in workspace"
            }
      - name: Ensure Dockerfile exists in docker-artifact
        run: |
          if (!(Test-Path docker-artifact\Dockerfile)) { Write-Error 'Dockerfile missing inside docker-artifact'; exit 1 }
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check Docker version
        run: docker --version

      - name: Build Docker image from docker-artifact
        run: |
          echo "Building image from docker-artifact/Dockerfile..."
          docker build -f docker-artifact/Dockerfile -t app:latest docker-artifact

      - name: Show Docker images
        run: docker images
      
            
    
